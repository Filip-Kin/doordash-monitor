<HTML>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <style>
            td {
                font-size: 24px;
            }
        </style>
    </head>
    <body>
        <div class="container center">
            <div class="row">
                <div class="input-field col s12">
                    <input type="text" name="device-id" id="device-id">
                    <label for="device-id">Device ID</label>
                </div>
            </div>
            <div class="row">
                <a href="#" class="btn" id="connect-btn">Connect</a>
            </div>
        </div>
        <div class="container" style="width: 90%; display: none" id="offer-ui">
            <div class="row">
                <div class="col s8">
                    <table>
                        <tr>
                            <td>Amount</td>
                            <td id="offer-amount" style="font-weight: 900; font-size: 36px"></td>
                        </tr>
                        <tr>
                            <td>Tip</td>
                            <td id="offer-tip"></td>
                        </tr>
                        <tr>
                            <td>Order</td>
                            <td id="offer-subtotal"></td>
                        </tr>
                        <tr>
                            <td>Store</td>
                            <td id="offer-store"></td>
                        </tr>
                        <tr>
                            <td>Drive Time</td>
                            <td id="offer-drivetime"></td>
                        </tr>
                        <tr>
                            <td>Estimated Hourly</td>
                            <td id="offer-hourly"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script>
            function padDecimal(str) {
                let parts = str.toString().split('.');
                if (parts[1] == undefined) parts[1] = '00';
                return `${parts[0]}.${parts[1].padEnd(2, '0')}`;
            }

            let ws;
            let id = localStorage.getItem('id');
            if (id) {
                document.getElementById('device-id').value = id;
                M.updateTextFields();
            }

            let connectButton = document.getElementById('connect-btn')
            connectButton.addEventListener('click', () => {
                document.documentElement.webkitRequestFullScreen();
                id = document.getElementById('device-id').value;
                ws = new WebSocket(`wss://${new URL(window.location).hostname}:9008`);
                localStorage.setItem('id', id);

                ws.addEventListener('message', (evt) => {
                    if (evt.data === 'OK') return ws.send(`CONNECT:${id}`);
                    let msg = JSON.parse(evt.data);
                    if (msg.type === "offer") {
                        updateOfferUI(msg);
                    }
                });
                connectButton.parentElement.parentElement.style.display = 'none';
                document.getElementById('offer-ui').style.display = 'block';
            });


            function updateOfferUI(offer) {
                document.getElementById('offer-amount').innerHTML = `$${padDecimal(offer.amount)}`;
                document.getElementById('offer-tip').innerHTML = `$${padDecimal(offer.tip)} ${offer.confident ? '&#10024;' : '&#10067;'}`;
                document.getElementById('offer-store').innerHTML = offer.store;
                document.getElementById('offer-drivetime').innerHTML = `${offer.driveTime} Mins`;
                document.getElementById('offer-hourly').innerHTML = `$${padDecimal(offer.hourly)}/hr`;
                document.getElementById('offer-subtotal').innerHTML = `$${padDecimal(offer.subtotal)}`;
            }
        </script>
    </body>
</HTML>